name: Create Kubernetes Cluster

on:
  workflow_dispatch:

jobs:
  create:
    name: Create self-managed Kubernetes cluster
    runs-on: self-hosted

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      TF_IN_AUTOMATION: "true"
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      # -------------------------------------------------
      # 1. Checkout repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Verify tools on runner
      # -------------------------------------------------
      - name: Verify tools
        run: |
          terraform version
          ansible --version

      # -------------------------------------------------
      # 3. Terraform Init
      # -------------------------------------------------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # -------------------------------------------------
      # 4. Terraform Apply
      # -------------------------------------------------
      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      # -------------------------------------------------
      # 5. Generate Ansible Inventory
      # -------------------------------------------------
      - name: Generate Ansible Inventory
        run: |
          chmod +x scripts/generate-inventory.sh
          ./scripts/generate-inventory.sh

      # -------------------------------------------------
      # 6. Setup Bastion + Build Kubernetes Cluster
      # (THIS does everything)
      # -------------------------------------------------
      - name: Setup Bastion and Bootstrap Cluster
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/bastion.yml
