name: Create Kubernetes Cluster

on:
  workflow_dispatch:

jobs:
  create:
    name: Create self-managed Kubernetes cluster
    runs-on: self-hosted

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      TF_IN_AUTOMATION: "true"
      ANSIBLE_HOST_KEY_CHECKING: "False"
      KUBECONFIG: ${{ github.workspace }}/kubeconfig

    steps:
      # -------------------------------------------------
      # 1. Checkout repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Verify required tools
      # -------------------------------------------------
      - name: Verify tools
        run: |
          terraform version
          ansible --version
          kubectl version --client

      # -------------------------------------------------
      # 3. Terraform Init
      # -------------------------------------------------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # -------------------------------------------------
      # 4. Terraform Apply
      # -------------------------------------------------
      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      # -------------------------------------------------
      # 5. Generate Ansible Inventory from Terraform outputs
      # -------------------------------------------------
      - name: Generate Ansible Inventory
        run: |
          chmod +x scripts/generate-inventory.sh
          ./scripts/generate-inventory.sh

      # -------------------------------------------------
      # 6. Wait for SSH to be ready on control plane
      # -------------------------------------------------
      - name: Wait for SSH (control plane)
        run: |
          CONTROL_PLANE_IP=$(terraform -chdir=terraform output -raw control_plane_ip)
          ./scripts/wait-for-ssh.sh "$CONTROL_PLANE_IP"




      # -------------------------------------------------
      # 7. Bootstrap all nodes (OS + containerd + kube tools)
      # -------------------------------------------------
      - name: Bootstrap Kubernetes Nodes
        run: |
          ansible-playbook ansible/playbooks/bootstrap.yml

      # -------------------------------------------------
      # 8. Initialize Control Plane
      # -------------------------------------------------
      - name: Initialize Control Plane
        run: |
          ansible-playbook ansible/playbooks/control-plane.yml

      # -------------------------------------------------
      # 9. Join Worker Nodes
      # -------------------------------------------------
      - name: Join Worker Nodes
        run: |
          ansible-playbook ansible/playbooks/workers.yml

      # -------------------------------------------------
      # 10. Install Calico CNI
      # -------------------------------------------------
      - name: Install Calico CNI
        run: |
          CONTROL_PLANE_IP=$(terraform -chdir=terraform output -raw control_plane_ip)

          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i /home/ec2-user/k8s_key_pair.pem \
              ubuntu@$CONTROL_PLANE_IP \
              "kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/calico.yaml"

      # -------------------------------------------------
      # 11. Fetch kubeconfig from control plane
      # -------------------------------------------------
      - name: Fetch kubeconfig
        run: |
          CONTROL_PLANE_IP=$(terraform -chdir=terraform output -raw control_plane_ip)
          chmod +x scripts/generate-kubeconfig.sh
          ./scripts/generate-kubeconfig.sh "$CONTROL_PLANE_IP"

      # -------------------------------------------------
      # 12. Verify cluster access from runner
      # -------------------------------------------------
      - name: Verify Cluster
        run: |
          kubectl get nodes
          kubectl get pods -n kube-system

      # -------------------------------------------------
      # 13. Upload kubeconfig as artifact (optional but recommended)
      # -------------------------------------------------
      - name: Upload kubeconfig artifact
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: kubeconfig




