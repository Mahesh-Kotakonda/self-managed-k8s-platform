name: Create Kubernetes Cluster

on:
  workflow_dispatch:

jobs:
  create:
    name: Create self-managed Kubernetes cluster
    runs-on: self-hosted

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      TF_IN_AUTOMATION: "true"
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      # -------------------------------------------------
      # 1. Checkout repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Verify required tools (runner)
      # -------------------------------------------------
      - name: Verify tools
        run: |
          terraform version
          ansible --version

      # -------------------------------------------------
      # 3. Terraform Init
      # -------------------------------------------------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # -------------------------------------------------
      # 4. Terraform Apply
      # -------------------------------------------------
      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      # -------------------------------------------------
      # 5. Generate Ansible Inventory (with bastion + ProxyJump)
      # -------------------------------------------------
      - name: Generate Ansible Inventory
        run: |
          chmod +x scripts/generate-inventory.sh
          ./scripts/generate-inventory.sh

      # -------------------------------------------------
      # 6. Setup Bastion (kubectl only)
      # -------------------------------------------------
      - name: Setup Bastion
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/bastion.yml

      # -------------------------------------------------
      # 7. Validate SSH connectivity (CRITICAL STEP)
      # -------------------------------------------------
      - name: Validate SSH Connectivity
        run: |
          ansible -i ansible/inventory/inventory.ini all -m ping

      # -------------------------------------------------
      # 8. Bootstrap Kubernetes Nodes
      # -------------------------------------------------
      - name: Bootstrap Kubernetes Nodes
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/bootstrap.yml

      # -------------------------------------------------
      # 9. Initialize Control Plane
      # -------------------------------------------------
      - name: Initialize Control Plane
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/control-plane.yml

      # -------------------------------------------------
      # 10. Join Worker Nodes
      # -------------------------------------------------
      - name: Join Worker Nodes
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/workers.yml
      # -------------------------------------------------
      # Install CNI (network)
      # -------------------------------------------------
      - name: Install Kubernetes Network (CNI)
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/network.yml
      # -------------------------------------------------
      # Copy kubeconfig to bastion
      # -------------------------------------------------
      - name: Copy kubeconfig to Bastion
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/kubeconfig.yml
      
      # -------------------------------------------------
      # Validate cluster from Bastion
      # -------------------------------------------------
      - name: Validate cluster from Bastion
        run: |
          ansible-playbook -i ansible/inventory/inventory.ini ansible/playbooks/validate.yml




